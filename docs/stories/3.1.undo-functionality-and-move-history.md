# Story 3.1: Undo Functionality and Move History

## Status
Draft

## Story
**As a player,**
**I want to undo my last move to correct mistakes or explore different strategies,**
**so that I can recover from errors and improve my gameplay.**

## Acceptance Criteria
1. Single-step undo functionality available during gameplay
2. Undo button clearly visible in game UI
3. Only current player can undo their own moves
4. Game state properly reverts when undo is used
5. Undo functionality works correctly with win detection
6. Move history is maintained for the current game session

## Tasks / Subtasks
- [ ] Implement move history tracking in GameBoardModel (AC: 6)
  - [ ] Add moveHistory List<Vector2Int> to GameBoardModel to store sequence of moves
  - [ ] Ensure moveHistory is updated with each valid move
  - [ ] Verify moveHistory persists across game state changes
- [ ] Create undo functionality in PiecePlacement system (AC: 1, 4)
  - [ ] Implement UndoLastMove() method in PiecePlacement component
  - [ ] Ensure undo operation removes the last placed piece from the board
  - [ ] Update game state (currentPlayer) to previous state after undo
  - [ ] Remove the last move from moveHistory
- [ ] Add UI elements for undo functionality (AC: 2)
  - [ ] Create undo button in in-game UI
  - [ ] Position undo button appropriately in game UI layout
  - [ ] Ensure undo button is only visible during gameplay state
- [ ] Implement validation rules for undo (AC: 3)
  - [ ] Add validation to ensure only current player can undo their own last move
  - [ ] Prevent undo when no moves have been made
  - [ ] Disable undo button when no moves are available to undo
- [ ] Test integration with win detection system (AC: 5)
  - [ ] Verify that undo functionality properly interacts with win detection
  - [ ] Ensure game state correctly reverts from "GameOver" to "Playing" if undo is used after a win
  - [ ] Confirm win detection runs correctly after undo operations
- [ ] Add audio feedback for undo action
  - [ ] Play sound effect when undo is performed
  - [ ] Ensure audio feedback is consistent with other game sounds

## Dev Notes

### Previous Story Insights
No specific insights from previous stories that directly impact undo functionality implementation.

### Data Models
- **GameBoardModel**: Contains moveHistory List<Vector2Int> to store the sequence of moves for undo functionality [Source: docs/game-architecture.md#gameboardmodel]
- **GameBoardModel.grid**: 15x15 array storing piece states (0=empty, 1=black, 2=white) which must be reverted during undo operations [Source: docs/game-architecture.md#gameboardmodel]
- **GameBoardModel.currentPlayer**: Tracks which player's turn it is (1=black, 2=white) which must be toggled back during undo operations [Source: docs/game-architecture.md#gameboardmodel]

### API Specifications
No specific API endpoints required for this story as it is a client-side feature.

### Component Specifications
- **PiecePlacement System**: Responsible for managing the placement of black and white pieces on valid board intersections. The undo functionality will be implemented as part of this system [Source: docs/game-architecture.md#piece-placement-system]
- **UI System**: The undo button will be integrated into the existing UI system with the UIManager component managing its state [Source: docs/game-architecture.md#ui-system]
- **Win Detection System**: Must be properly integrated with undo functionality to ensure game state transitions work correctly [Source: docs/game-architecture.md#win-detection-system]

### File Locations
- GameBoardModel ScriptableObject: `Assets/_Project/Data/GameBoard/`
- PiecePlacement component: `Assets/_Project/Scripts/Piece/PiecePlacement.cs` [Source: docs/game-architecture.md#piece-placement-system]
- UIManager component: `Assets/_Project/Scripts/UI/UIManager.cs` [Source: docs/game-architecture.md#ui-system]
- Game state management: `Assets/_Project/Scripts/GameState/GameStateManager.cs` [Source: docs/game-architecture.md#game-state-manager-system]

### Testing Requirements
- Implement unit tests for the UndoLastMove() method to verify proper functionality
- Create integration tests to validate UI button interaction with the undo system
- Test edge cases such as attempting to undo when no moves have been made
- Verify that the moveHistory list is properly maintained and updated
- Test integration with win detection system to ensure proper state transitions
- Follow the test strategy outlined in the architecture document [Source: docs/game-architecture.md#test-strategy-and-standards]

### Technical Constraints
- Unity Version: 2022.3 LTS [Source: docs/game-architecture.md#core-standards]
- C# Language Version: 10.0 [Source: docs/game-architecture.md#core-standards]
- Performance: Game must maintain 60 FPS during normal gameplay including undo operations [Source: PRD Non-Functional Requirements]
- Input response time must be under 100ms for undo button interactions [Source: PRD Non-Functional Requirements]

## Testing
- **Test Location:** `Assets/_Project/Tests/`
- **Test Standards:** Follow Unity Test Framework (NUnit-based) as specified in the architecture document [Source: docs/game-architecture.md#core-standards]
- **Testing Framework:** Unity Test Framework with 70% Edit Mode tests and 30% Play Mode tests [Source: docs/game-architecture.md#test-strategy-and-standards]
- **Test Types:**
  - Edit Mode Tests: Test the UndoLastMove() method logic without Unity runtime
  - Play Mode Tests: Test UI interactions with the undo button and integration with game systems
- **Specific Testing Requirements for this Story:**
  - Test that the moveHistory list correctly stores and retrieves moves
  - Verify that undo operations properly revert the game board state
  - Ensure that currentPlayer is correctly updated after undo
  - Validate that the undo button is disabled when no moves are available to undo
  - Test that win detection system properly handles game state transitions when undo is used after a win
  - Verify that audio feedback plays consistently with other game sounds

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | v1.0 | Initial story creation for undo functionality | Bob (Scrum Master) |