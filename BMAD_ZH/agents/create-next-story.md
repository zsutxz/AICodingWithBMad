# 创建下一个故事任务

## 目的

根据项目进度和史诗定义识别下一个逻辑故事，然后使用`故事模板`准备一个全面、独立且可操作的故事文件。此任务确保故事包含所有必要的技术背景、需求和验收标准，使其能够由开发代理高效实施，而无需进行额外的研究或寻找自己的上下文。

## 顺序任务执行（在当前任务完成前不要继续）

### 0. 加载核心配置并检查工作流程

- 从项目根目录加载`{root}/core-config.yaml`
- 如果文件不存在，则停止并通知用户："未找到core-config.yaml。此文件是创建故事所必需的。您可以选择：1）从GITHUB bmad-core/core-config.yaml复制并为您的项目配置它，或2）对您的项目运行BMad安装程序以自动升级和添加该文件。请在继续之前添加并配置core-config.yaml。"
- 提取关键配置：`devStoryLocation`、`prd.*`、`architecture.*`、`workflow.*`

### 1. 确定要准备的下一个故事

#### 1.1 定位史诗文件并审查现有故事

- 根据配置中的`prdSharded`定位史诗文件（分片位置/模式或单体PRD部分）
- 如果`devStoryLocation`有故事文件，加载最高编号的`{epicNum}.{storyNum}.story.md`文件
- **如果存在最高编号的故事：**
  - 验证状态是否为"完成"。如果不是，提醒用户："警报：发现未完成的故事！文件：{lastEpicNum}.{lastStoryNum}.story.md 状态：[当前状态] 您应该先修复这个故事，但您是否愿意接受风险并覆盖以创建下一个草稿故事？"
  - 如果继续，选择当前史诗中的下一个顺序故事
  - 如果史诗已完成，提示用户："史诗{epicNum}已完成：史诗{epicNum}中的所有故事都已完成。您是否愿意：1）开始史诗{epicNum + 1}的第一个故事 2）选择特定故事进行处理 3）取消故事创建"
  - **关键**：切勿自动跳转到另一个史诗。用户必须明确指示要创建哪个故事。
- **如果没有故事文件存在：** 下一个故事始终是1.1（第一个史诗的第一个故事）
- 向用户宣布识别的故事："已识别出要准备的下一个故事：{epicNum}.{storyNum} - {故事标题}"

### 2. 收集故事需求和前一个故事的上下文

- 从识别的史诗文件中提取故事需求
- 如果存在前一个故事，审查开发代理记录部分以获取：
  - 完成说明和调试日志引用
  - 实施偏差和技术决策
  - 遇到的挑战和经验教训
- 提取相关的见解来指导当前故事的准备工作

### 3. 收集架构上下文

#### 3.1 确定架构阅读策略

- **如果`architectureVersion: >= v4`且`architectureSharded: true`**：阅读`{architectureShardedLocation}/index.md`然后按照下面的结构化阅读顺序进行
- **否则**：对类似部分使用单体`architectureFile`

#### 3.2 根据故事类型阅读架构文档

**对于所有故事：** tech-stack.md, unified-project-structure.md, coding-standards.md, testing-strategy.md

**对于后端/API故事，另外：** data-models.md, database-schema.md, backend-architecture.md, rest-api-spec.md, external-apis.md

**对于前端/UI故事，另外：** frontend-architecture.md, components.md, core-workflows.md, data-models.md

**对于全栈故事：** 阅读上述后端和前端部分

#### 3.3 提取特定于故事的技术细节

仅提取与实现当前故事直接相关的信息。不要编造源文档中没有的新库、模式或标准。

提取：

- 故事将使用的特定数据模型、模式或结构
- 故事必须实现或使用的API端点
- 故事中UI元素的组件规范
- 新代码的文件路径和命名约定
- 故事功能的特定测试要求
- 影响故事的安全性或性能考虑

始终引用源文档：`[来源：architecture/{filename}.md#{section}]`

### 4. 验证项目结构对齐

- 将故事需求与来自`docs/architecture/unified-project-structure.md`的项目结构指南进行交叉引用
- 确保文件路径、组件位置或模块名称与定义的结构对齐
- 在故事草稿中的"项目结构说明"部分记录任何结构冲突

### 5. 使用完整上下文填充故事模板

- 使用故事模板创建新故事文件：`{devStoryLocation}/{epicNum}.{storyNum}.story.md`
- 填写基本故事信息：标题、状态（草稿）、故事陈述、来自史诗的验收标准
- **`开发说明`部分（关键）：**
  - 关键：此部分必须仅包含从架构文档中提取的信息。切勿编造或假设技术细节。
  - 包含步骤2-3中的所有相关技术细节，按类别组织：
    - **前一个故事的见解**：从前一个故事中获得的关键经验
    - **数据模型**：特定的模式、验证规则、关系[带来源引用]
    - **API规范**：端点详细信息、请求/响应格式、认证要求[带来源引用]
    - **组件规范**：UI组件详细信息、属性、状态管理[带来源引用]
    - **文件位置**：基于项目结构应创建新代码的确切路径
    - **测试要求**：来自testing-strategy.md的特定测试用例或策略
    - **技术约束**：版本要求、性能考虑、安全规则
  - 每个技术细节必须包含其来源引用：`[来源：architecture/{filename}.md#{section}]`
  - 如果在架构文档中找不到某个类别的信息，明确说明："在架构文档中未找到特定指导"
- **`任务/子任务`部分：**
  - 仅基于以下内容生成详细、顺序的技术任务列表：史诗需求、故事验收标准、审查的架构信息
  - 每个任务必须引用相关的架构文档
  - 根据测试策略将单元测试作为明确的子任务包含在内
  - 在适用的情况下将任务与验收标准关联（例如，`任务1（验收标准：1, 3）`）
- 添加在步骤4中发现的项目结构对齐或差异说明

### 6. 故事草稿完成和审查

- 审查所有部分的完整性和准确性
- 验证所有技术细节都包含来源引用
- 确保任务与史诗需求和架构约束对齐
- 更新状态为"草稿"并保存故事文件
- 执行`{root}/tasks/execute-checklist` `{root}/checklists/story-draft-checklist`
- 向用户提供摘要，包括：
  - 创建的故事：`{devStoryLocation}/{epicNum}.{storyNum}.story.md`
  - 状态：草稿
  - 从架构文档中包含的关键技术组件
  - 注意到的史诗和架构之间的任何偏差或冲突
  - 检查表结果
  - 后续步骤：对于复杂故事，建议用户仔细审查故事草稿，也可以选择让产品负责人运行任务`{root}/tasks/validate-next-story`