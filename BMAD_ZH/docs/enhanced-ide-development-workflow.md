# 增强的 IDE 开发工作流程

这是一个简单的分步指南，旨在帮助您使用 BMad 方法高效管理开发工作流程。该工作流程在整个开发生命周期中集成了测试架构师（QA Agent），以确保质量、防止回归并保持高标准。如此处未涵盖的任何场景，请参阅**[<ins>用户指南</ins>](user-guide.md)**。

## 创建新分支

1. **启动新分支**

## 故事创建 (Scrum Master)

1. **开始新的聊天/对话**
2. **加载 SM Agent**
3. **执行**：`*draft` (运行 create-next-story 任务)
4. **审查生成的故事**，位于 `docs/stories/`
5. **更新状态**：从“草稿”更改为“已批准”

## 故事实施 (开发人员)

1. **开始新的聊天/对话**
2. **加载 Dev Agent**
3. **执行**：`*develop-story {selected-story}` (运行 execute-checklist 任务)
4. **审查生成的报告**，位于 `{selected-story}`

## 测试架构师在整个工作流程中的集成

测试架构师 (Quinn) 在整个开发生命周期中提供全面的质量保证。以下是如何在适当的时候利用每项功能。

**命令别名：** 文档使用缩写形式 (`*risk`, `*design`, `*nfr`, `*trace`) 来代表完整命令 (`*risk-profile`, `*test-design`, `*nfr-assess`, `*trace-requirements`)。

### 快速命令参考

| **阶段** | **命令** | **目的** | **输出** | **优先级** |
| --- | --- | --- | --- | --- |
| **故事批准后** | `*risk` | 识别集成和回归风险 | `docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md` | 对于复杂/褐地项目为高 |
| | `*design` | 为开发创建测试策略 | `docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md` | 对于新功能为高 |
| **开发期间** | `*trace` | 验证测试覆盖率 | `docs/qa/assessments/{epic}.{story}-trace-{YYYYMMDD}.md` | 中 |
| | `*nfr` | 验证质量属性 | `docs/qa/assessments/{epic}.{story}-nfr-{YYYYMMDD}.md` | 对于关键功能为高 |
| **开发后** | `*review` | 全面评估 | 故事中的 QA 结果 + `docs/qa/gates/{epic}.{story}-{slug}.yml` | **必需** |
| **审查后** | `*gate` | 更新质量决策 | 更新的 `docs/qa/gates/{epic}.{story}-{slug}.yml` | 根据需要 |

### 阶段 1：故事创建后 (开发开始前)

**推荐 - 为开发人员的成功做好准备：**

```bash
# 1. 风险评估 (对于复杂故事，首先运行)
@qa *risk {approved-story}
# 识别：
#   - 技术债务影响
#   - 集成复杂性
#   - 回归可能性 (1-9 评分)
#   - 缓解策略
# 关键适用于：褐地项目、API 变更、数据迁移

# 2. 测试设计 (其次运行以指导实施)
@qa *design {approved-story}
# 提供：
#   - 每个验收标准的测试场景
#   - 测试级别建议 (单元/集成/E2E)
#   - 基于风险的优先级 (P0/P1/P2)
#   - 测试数据要求
# 与开发人员分享：包含在故事评论中或附加到工单
```

### 阶段 2：开发期间 (实施中期检查点)

**开发人员自助质量检查：**

```bash
# 3. 需求追踪 (在开发中期验证覆盖率)
@qa *trace {story-in-progress}
# 验证：
#   - 所有验收标准都有测试
#   - 没有遗漏的测试场景
#   - 适当的测试级别
#   - Given-When-Then 文档的清晰度
# 运行时间：编写初始测试后

# 4. NFR 验证 (检查质量属性)
@qa *nfr {story-in-progress}
# 评估：
#   - 安全性：认证、授权、数据保护
#   - 性能：响应时间、资源使用
#   - 可靠性：错误处理、恢复
#   - 可维护性：代码质量、文档
# 运行时间：标记为“准备审查”之前
```

### 阶段 3：故事审查 (质量门评估)

**必需 - 全面的测试架构审查：**

**先决条件：** 所有测试在本地通过；lint 和类型检查通过。

```bash
# 5. 全面审查 (标准审查流程)
@qa *review {completed-story}
```

**审查期间会发生什么：**

1.  **深度代码分析**
    *   架构模式合规性
    *   代码质量和可维护性
    *   安全漏洞扫描
    *   性能瓶颈检测
2.  **主动重构**
    *   在安全的情况下直接改进代码
    *   立即修复明显问题
    *   为开发人员建议复杂的重构
3.  **测试验证**
    *   所有级别的覆盖率 (单元/集成/E2E)
    *   测试质量 (无不稳定测试，断言正确)
    *   回归测试的充分性
4.  **质量门决策**
    *   创建：`docs/qa/gates/{epic}.{story}-{slug}.yml`
    *   添加：QA 结果部分到故事文件
    *   状态：通过/关注/失败/豁免

### 阶段 4：审查后 (解决问题后)

**修复后更新质量门状态：**

```bash
# 6. 质量门更新 (记录最终决策)
@qa *gate {reviewed-story}
# 更新：质量门的新状态
# 使用时机：解决审查反馈后
# 记录：修复了什么，豁免了什么
```

### 理解质量门决策

| **状态** | **含义** | **需要采取的行动** | **可以继续吗？** |
| --- | --- | --- | --- |
| **通过 (PASS)** | 所有关键需求均已满足 | 无 | ✅ 是 |
| **关注 (CONCERNS)** | 发现非关键问题 | 建议团队审查 | ⚠️ 谨慎进行 |
| **失败 (FAIL)** | 关键问题 (安全、缺少 P0 测试) | 必须修复 | ❌ 否 |
| **豁免 (WAIVED)** | 问题已确认并接受 | 记录原因 | ✅ 经批准后 |

### 基于风险的测试策略

测试架构师使用风险评分来确定测试优先级：

| **风险评分** | **计算** | **测试优先级** | **对质量门的影响** |
| --- | --- | --- | --- |
| **9** | 高概率 × 高影响 | P0 - 必须彻底测试 | 如果未测试则失败 |
| **6** | 中高组合 | P1 - 应充分测试 | 如果存在差距则关注 |
| **4** | 中等组合 | P1 - 应测试 | 如果存在显著差距则关注 |
| **2-3** | 中低组合 | P2 - 有则更好 | 在审查中注明 |
| **1** | 风险极小 | P2 - 最低限度 | 在审查中注明 |

### 特殊情况和最佳实践

#### 高风险或褐地故事

```bash
# 始终按此顺序运行：
@qa *risk {story}    # 首先 - 识别危险
@qa *design {story}  # 其次 - 规划防御
# 然后在开发期间：
@qa *trace {story}   # 验证回归覆盖率
@qa *nfr {story}     # 检查性能影响
# 最后：
@qa *review {story}  # 深度集成分析
```

#### 复杂的集成

*   在开发过程中多次运行 `*trace`
*   关注集成测试覆盖率
*   使用 `*nfr` 验证跨系统性能
*   在审查时特别注意 API 合约

#### 性能关键功能

*   尽早并经常运行 `*nfr` (不仅仅是在审查时)
*   在变更前建立性能基线
*   记录可接受的性能下降
*   在 `*design` 中考虑负载测试要求

### 强制执行的测试质量标准

Quinn 确保所有测试都符合这些标准：

*   **无不稳定测试**：正确的异步处理，显式等待
*   **无硬等待**：仅使用动态策略 (轮询、事件)
*   **无状态**：测试可独立并行运行
*   **自我清理**：测试管理自己的测试数据
*   **适当的级别**：单元测试用于逻辑，集成测试用于交互，E2E 测试用于用户旅程
*   **清晰的断言**：将断言保留在测试中，而不是隐藏在辅助函数中

### 文档和审计追踪

所有测试架构师的活动都会创建永久记录：

*   **评估报告**：带时间戳的分析，位于 `docs/qa/assessments/`
*   **质量门文件**：决策记录，位于 `docs/a/gates/`
*   **故事更新**：故事文件中的 QA 结果部分
*   **可追溯性**：维护需求到测试的映射

## 提交变更并推送

1.  **提交变更**
2.  **推送到远程仓库**

## 完整的开发周期流程

### 包含测试架构师的完整工作流程

1.  **SM**：创建下一个故事 → 审查 → 批准
2.  **QA (可选)**：风险评估 (`*risk`) → 测试设计 (`*design`)
3.  **开发**：实施故事 → 编写测试 → 完成
4.  **QA (可选)**：开发中期检查 (`*trace`, `*nfr`)
5.  **开发**：标记为准备审查
6.  **QA (必需)**：审查故事 (`*review`) → 质量门决策
7.  **开发 (如果需要)**：解决问题
8.  **QA (如果需要)**：更新质量门 (`*gate`)
9.  **提交**：所有变更
10. **推送**：到远程仓库
11. **继续**：直到所有功能实现

### 快速决策指南

**我应该运行测试架构师命令吗？**

| **场景** | **开发前** | **开发中** | **开发后** |
| --- | --- | --- | --- |
| **简单的错误修复** | 可选 | 可选 | 必需 `*review` |
| **新功能** | 推荐 `*risk`, `*design` | 可选 `*trace` | 必需 `*review` |
| **褐地项目变更** | **必需** `*risk`, `*design` | 推荐 `*trace`, `*nfr` | 必需 `*review` |
| **API 修改** | **必需** `*risk`, `*design` | **必需** `*trace` | 必需 `*review` |
| **性能关键** | 推荐 `*design` | **必需** `*nfr` | 必需 `*review` |
| **数据迁移** | **必需** `*risk`, `*design` | **必需** `*trace` | 必需 `*review` + `*gate` |

### 成功指标

测试架构师帮助实现：

*   生产中**零回归缺陷**
*   测试**100% 覆盖需求**
*   **清晰的质量门**用于决策
*   **记录在案的风险接受**用于技术债务
*   团队中**一致的测试质量**
*   通过早期风险识别实现**左移测试**
