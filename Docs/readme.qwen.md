# BMAD-METHOD™ 项目底层调用机制详解

## 1. 整体架构

BMAD-METHOD™ 项目的底层调用基于一个模块化的架构，主要包括以下几个核心组件：

1. **CLI工具**: 项目的命令行接口，负责处理用户输入的命令并调用相应的功能模块。
2. **安装器(Installer)**: 负责项目的安装、更新和配置。
3. **代理系统(Agents)**: 各种专门化的AI代理，如PM、Architect、Dev等，每个代理都有特定的职责和能力。
4. **任务系统(Tasks)**: 可执行的工作单元，代理可以调用这些任务来完成具体的工作。
5. **模板系统(Templates)**: 提供文档和代码的模板，用于生成标准化的输出。

## 2. 启动流程

### 2.1 通过npx启动

用户可以通过以下命令启动BMAD-METHOD™：

```bash
npx bmad-method install
```

这个命令会执行以下步骤：

1. `npx`会下载并执行`bmad-npx-wrapper.js`脚本。
2. `bmad-npx-wrapper.js`会检测是否在npx临时目录中运行。
3. 如果是在npx中运行，它会调用`tools/installer/bin/bmad.js`来处理命令。
4. `bmad.js`会解析命令行参数，并根据参数调用相应的功能。

### 2.2 安装器执行

当用户运行`npx bmad-method install`时，安装器会执行以下步骤：

1. 解析命令行参数。
2. 检测当前安装状态（全新安装、更新现有安装等）。
3. 根据检测结果执行相应的安装逻辑：
   - 全新安装：复制`.bmad-core`文件夹到项目目录。
   - 更新安装：更新现有文件并添加新文件。
4. 配置IDE集成（如果用户选择了IDE）。
5. 安装扩展包（如果用户选择了扩展包）。

## 3. PM代理调用流程

### 3.1 PM代理激活

PM代理是产品管理代理，负责创建产品需求文档(PRD)等工作。当用户需要使用PM代理时，会执行以下步骤：

1. 加载PM代理定义文件(`bmad-core/agents/pm.md`)。
2. 解析YAML配置，包括代理信息、命令列表和依赖项。
3. 根据配置加载必要的依赖项（任务、模板、数据文件等）。

### 3.2 创建PRD文档

当用户执行`*create-prd`命令时，会触发以下流程：

1. PM代理调用`create-doc`任务。
2. `create-doc`任务加载PRD模板(`bmad-core/templates/prd-tmpl.yaml`)。
3. 根据模板定义，任务会逐步引导用户完成PRD的各个部分：
   - Goals and Background Context
   - Requirements
   - User Interface Design Goals
   - Technical Assumptions
   - Epic List
   - Epic Details
   - Checklist Results Report
   - Next Steps
4. 对于每个部分，如果`elicit`设置为`true`，任务会要求用户输入或确认内容。
5. 最终生成的PRD文档保存到`docs/prd.md`。

### 3.3 交互式询问机制

在创建PRD的过程中，当遇到需要用户输入的部分时，系统会使用一种严格的交互式询问机制：

1. 显示当前部分的内容和详细理由（解释权衡、假设和决策）。
2. 提供编号选项1-9：
   - 选项1：继续到下一部分
   - 选项2-9：从`elicitation-methods.md`中选择8种询问方法
3. 等待用户响应，根据用户选择执行相应的操作。

这种机制确保了用户能够精确地控制文档创建过程，并提供了多种方式来提供反馈和指导。

## 4. 依赖管理系统

BMAD-METHOD™ 使用一个依赖管理系统来管理代理、任务和模板之间的依赖关系：

1. 每个代理都有一个`dependencies`部分，列出它需要的任务、模板、检查清单和数据文件。
2. 当代理被激活时，只会加载其直接依赖的文件。
3. 当用户执行特定任务时，才会加载该任务所需的依赖文件。
4. 依赖文件的路径遵循特定的规则：`{root}/{type}/{name}`，其中`type`是文件夹名称（tasks、templates等），`name`是文件名。

## 5. 文件结构和路径解析

BMAD-METHOD™ 项目的文件结构设计支持灵活的路径解析：

1. 核心文件位于`.bmad-core`目录下，包括代理、任务、模板、数据文件等。
2. 项目配置文件位于`.bmad-core/core-config.yaml`，定义了项目的基本配置。
3. 生成的文档通常保存在`docs`目录下。
4. 扩展包位于`expansion-packs`目录下，每个扩展包都有自己的目录结构。

## 6. 总结

BMAD-METHOD™ 的底层调用机制是一个精心设计的模块化系统，通过CLI工具、安装器、代理系统、任务系统和模板系统的协同工作，实现了灵活而强大的AI辅助开发流程。PM代理作为其中的一个重要组件，通过严格的交互式流程和依赖管理，能够帮助用户创建高质量的产品需求文档。